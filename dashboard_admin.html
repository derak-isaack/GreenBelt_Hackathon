<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Forest Tracker - Dashboard</title>
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body class="dark">
  <header class="fixed top-0 left-0 right-0 z-50 bg-background/80 backdrop-blur-md border-b border-border">
  <div class="container mx-auto px-4 py-4">
    <div class="flex items-center justify-between w-full">
      <a href="/" class="flex items-center gap-3 hover:opacity-80 transition-opacity">
        <img src="/assets/generated/forest-tracker-logo-transparent.dim_200x200.png" alt="Forest Tracker" class="h-10 w-10" onerror="this.style.display='none'">
        <span class="text-xl font-bold text-forest-primary">Forest Tracker</span>
      </a>

      <nav class="hidden md:flex ml-auto">
        <ul class="nav-list">
          <li>
            <a href="/" class="text-sm font-medium text-foreground/80 hover:text-forest-primary transition-colors ">Home</a>
          </li>
          <li>
            <a href="/dashboard" class="text-sm font-medium text-foreground/80 hover:text-forest-primary transition-colors text-forest-primary">Dashboard</a>
          </li>
          <li>
            <a href="/resources" class="text-sm font-medium text-foreground/80 hover:text-forest-primary transition-colors ">Resources</a>
          </li>
          <li>
            <a href="/report" class="text-sm font-medium text-foreground/80 hover:text-forest-primary transition-colors ">Report</a>
          </li>
          
          <li>
            <a href="/admin" class="text-sm font-medium text-foreground/80 hover:text-forest-primary transition-colors ">Admin</a>
          </li>
          
          <li>
            <button type="button" id="loginBtn" class="btn btn-primary">
              <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
              </svg>
              Login
            </button>
          </li>
        </ul>
      </nav>

      <!-- Mobile Menu Button -->
      <button id="mobileMenuBtn" class="md:hidden p-2 hover:bg-muted rounded-md">
        <svg id="menuIcon" class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
        </svg>
        <svg id="closeIcon" class="h-5 w-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>

    <!-- Mobile Navigation -->
    <nav id="mobileMenu" class="md:hidden hidden mt-4 pb-4">
      <ul class="nav-list nav-list-vertical">
        <li>
          <a href="/" class="text-sm font-medium text-foreground/80 hover:text-forest-primary transition-colors py-2 ">Home</a>
        </li>
        <li>
          <a href="/dashboard" class="text-sm font-medium text-foreground/80 hover:text-forest-primary transition-colors py-2 text-forest-primary">Dashboard</a>
        </li>
        <li>
          <a href="/resources" class="text-sm font-medium text-foreground/80 hover:text-forest-primary transition-colors py-2 ">Resources</a>
        </li>
        <li>
          <a href="/report" class="text-sm font-medium text-foreground/80 hover:text-forest-primary transition-colors py-2 ">Report</a>
        </li>
        
        <li>
          <a href="/admin" class="text-sm font-medium text-foreground/80 hover:text-forest-primary transition-colors py-2 ">Admin</a>
        </li>
        
        <li class="w-full">
          <button type="button" id="mobileLoginBtn" class="btn btn-primary w-full">
            <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
            </svg>
            Login
          </button>
        </li>
      </ul>
    </nav>
  </div>
</header>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const mobileMenuBtn = document.getElementById('mobileMenuBtn');
    const mobileMenu = document.getElementById('mobileMenu');
    const menuIcon = document.getElementById('menuIcon');
    const closeIcon = document.getElementById('closeIcon');
    const loginBtn = document.getElementById('loginBtn');
    const mobileLoginBtn = document.getElementById('mobileLoginBtn');
    
    if (mobileMenuBtn && mobileMenu) {
      mobileMenuBtn.addEventListener('click', () => {
        const isOpen = !mobileMenu.classList.contains('hidden');
        mobileMenu.classList.toggle('hidden');
        menuIcon.classList.toggle('hidden');
        closeIcon.classList.toggle('hidden');
      });
    }

    // Check if user is logged in first
    const authToken = localStorage.getItem('authToken');
    const username = localStorage.getItem('username');
    
    // Login button handlers - redirect to login page or logout
    const handleLogin = (e) => {
      e.preventDefault();
      e.stopPropagation();
      
      if (authToken) {
        // User is logged in, show logout confirmation
        if (confirm('Do you want to log out?')) {
          localStorage.removeItem('authToken');
          localStorage.removeItem('username');
          localStorage.removeItem('rememberMe');
          window.location.reload();
        }
      } else {
        // User is not logged in, redirect to login page
        const currentPath = window.location.pathname;
        window.location.href = '/login?redirect=' + encodeURIComponent(currentPath);
      }
    };

    // Update button text if logged in
    if (authToken && loginBtn) {
      const icon = loginBtn.querySelector('svg') ? loginBtn.querySelector('svg').outerHTML : '';
      loginBtn.innerHTML = icon + (username || 'Account');
    }
    
    if (authToken && mobileLoginBtn) {
      const icon = mobileLoginBtn.querySelector('svg') ? mobileLoginBtn.querySelector('svg').outerHTML : '';
      mobileLoginBtn.innerHTML = icon + (username || 'Account');
    }

    // Add event listeners
    if (loginBtn) {
      loginBtn.addEventListener('click', handleLogin);
    }
    if (mobileLoginBtn) {
      mobileLoginBtn.addEventListener('click', handleLogin);
    }
  });
</script>


  
  <main class="flex-1">
<div class="relative min-h-screen bg-light-surface">
  <div class="relative pt-32 pb-20 px-4">
    <div class="container mx-auto max-w-7xl">
      <div class="section-header mb-12">
        <h1 class="section-title">Analytics <span class="text-forest-primary">Dashboard</span></h1>
        <p class="section-description">
          Real-time monitoring of forest health, encroachment levels, and conservation metrics.
        </p>
      </div>

      <!-- Summary Cards -->
      <div class="grid md:grid-cols-3 gap-6 mb-8">
        
        <div class="stat-card">
          <p class="card-description mb-2">Total Reports</p>
          <div class="stat-value" id="totalReports">-</div>
          <div class="stat-label">Anonymous submissions received</div>
        </div>
        

        <div class="stat-card">
          <p class="card-description mb-2">Monitored Areas</p>
          <div class="stat-value" id="monitoredAreas">-</div>
          <div class="stat-label">Active monitoring locations</div>
        </div>

        <div class="stat-card">
          <p class="card-description mb-2">Avg. Forest Health</p>
          <div class="stat-value" id="avgHealth">-</div>
          <div class="stat-label">Overall ecosystem health score</div>
        </div>
      </div>
      <!-- Filters and Alerts -->
      <div class="grid md:grid-cols-2 gap-6 mb-8">
        <!-- Filter Card -->
        <div class="card bg-card/80 backdrop-blur-sm border-forest-border">
          <div class="card-header">
            <h3 class="card-title">Filters</h3>
          </div>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium mb-2">Year</label>
              <select id="yearFilter" class="w-full px-3 py-2 bg-card border border-forest-border rounded-md text-foreground">
                <option value="">All Years</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium mb-2">Forest Name</label>
              <select id="forestFilter" class="w-full px-3 py-2 bg-card border border-forest-border rounded-md text-foreground">
                <option value="">All Forests</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium mb-2">Month</label>
              <select id="monthFilter" class="w-full px-3 py-2 bg-card border border-forest-border rounded-md text-foreground">
                <option value="">All Months</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Alerts Card -->
        <div class="stat-card">
          <p class="card-description mb-2">Alerts Above RFDI Threshold</p>
          <div class="stat-value" id="alertsCount">-</div>
          <div class="stat-label">Number of alerts exceeding threshold</div>
        </div>
      </div>

      <!-- RFDI Trend -->
      <div class="space-y-6 mb-8">
        <h2 class="text-2xl font-bold text-foreground flex items-center gap-2">
          <svg class="h-6 w-6 text-forest-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3v18h18"></path>
          </svg>
          RFDI Trend
        </h2>
        <p class="text-sm text-muted-foreground mb-4">
          Radar Forest Degradation Index (RFDI) measures forest health using satellite radar data. Values closer to 0 indicate healthy forests, while higher values (>0.3) signal potential degradation or alerts. Monitoring RFDI helps track environmental conservation efforts and biodiversity protection in ASAL areas.
        </p>
        <div class="card bg-card/80 backdrop-blur-sm border-forest-border">
          <div id="ndviStatus" class="text-center py-6 text-muted-foreground">
            Loading RFDI trend...
          </div>
          <canvas id="ndviChart" class="hidden mt-6 h-64"></canvas>
        </div>
      </div>

      <!-- Policy Analysis -->
      <div class="space-y-6 mb-8">
        <h2 class="text-2xl font-bold text-foreground flex items-center gap-2">
          <svg class="h-6 w-6 text-forest-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
          </svg>
          Policy Analysis
        </h2>
        <div id="policyAnalysis" class="card bg-card/80 backdrop-blur-sm border-forest-border">
          <div class="text-center py-6 text-muted-foreground">
            Loading policy analysis...
          </div>
        </div>
      </div>

      <!-- Dashboard Data -->
      <div class="space-y-6 mb-8">
        <h2 class="text-2xl font-bold text-foreground flex items-center gap-2">
          <svg class="h-6 w-6 text-forest-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
          </svg>
          Forest Monitoring Data
        </h2>

        <div id="dashboardData" class="grid md:grid-cols-2 gap-6">
          <div class="text-center py-12">
            <span class="spinner"></span>
            <p class="text-muted-foreground mt-4">Loading data...</p>
          </div>
        </div>
      </div>

      <!-- Recent Reports -->
      
      <div class="space-y-6">
        <h2 class="text-2xl font-bold text-foreground flex items-center gap-2">
          <svg class="h-6 w-6 text-forest-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
          </svg>
          Recent Reports
        </h2>

        <div id="reportsList" class="space-y-4">
          <div class="text-center py-12">
            <span class="spinner"></span>
            <p class="text-muted-foreground mt-4">Loading reports...</p>
          </div>
        </div>
      </div>
      
    </div>
  </div>
</div>
  </main>

  <footer class="bg-forest-dark text-forest-light border-t border-forest-border">
  <div class="container mx-auto px-4 py-8">
    <div class="grid md:grid-cols-2 gap-8 mb-6">
      <!-- Contact Us Section -->
      <div>
        <h3 class="text-lg font-semibold text-forest-primary mb-4">Contact Us</h3>
        <div class="space-y-3 text-sm">
          <div class="flex items-start gap-3">
            <svg class="h-5 w-5 text-forest-accent flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
            </svg>
            <span>Email: info@snetinel.co.ke</span>
          </div>
          <div class="flex items-start gap-3">
            <svg class="h-5 w-5 text-forest-accent flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
            </svg>
            <span>Phone: +1 (555) 123-4567</span>
          </div>
          <div class="flex items-start gap-3">
            <svg class="h-5 w-5 text-forest-accent flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
            </svg>
            <span>Address: 123 Kenyatta Avenue, Nairobi, NRB 12035</span>
          </div>
        </div>
      </div>
      
      <!-- Mission Statement -->
      <div>
        <h3 class="text-lg font-semibold text-forest-primary mb-4">Our Mission</h3>
        <p class="text-sm text-forest-light/80 leading-relaxed">
          Protecting forests for future generations through technology, community engagement, and conservation efforts.
        </p>
      </div>
    </div>
    
    <!-- Copyright -->
    <div class="border-t border-forest-border pt-6 text-center text-sm text-forest-light/70">
      <p>Â© 2025 Forest Tracker. All rights reserved.</p>
    </div>
  </div>
</footer>



  <script src="/js/forest-background.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js" crossorigin="anonymous"></script>

  <script>
  window.userRole = 'admin';
  const dashboardContainer = document.getElementById('dashboardData');
  const reportsContainer = document.getElementById('reportsList');
  const ndviStatus = document.getElementById('ndviStatus');
  const ndviCanvas = document.getElementById('ndviChart');
  let ndviChartInstance = null;
  let hasLoadedNdvi = false;
  let hasLoadedDashboard = false;
  let hasLoadedReports = false;
  let refreshTimer = null;
  const REFRESH_INTERVAL = 60000;

  function getHealthStatus(health) {
    if (health >= 80) return { label: 'Excellent', color: 'bg-green-500/20 text-green-600 border-green-500/30' };
    if (health >= 60) return { label: 'Good', color: 'bg-forest-primary/20 text-forest-primary border-forest-primary/30' };
    if (health >= 40) return { label: 'Fair', color: 'bg-yellow-500/20 text-yellow-600 border-yellow-500/30' };
    return { label: 'Critical', color: 'bg-red-500/20 text-red-600 border-red-500/30' };
  }

  function getEncroachmentLevel(level) {
    if (level >= 70) return { label: 'High', color: 'bg-red-500/20 text-red-600 border-red-500/30' };
    if (level >= 40) return { label: 'Medium', color: 'bg-yellow-500/20 text-yellow-600 border-yellow-500/30' };
    return { label: 'Low', color: 'bg-green-500/20 text-green-600 border-green-500/30' };
  }

  function updateSummaryCards(dashboardData, reports) {
    const totalReportsEl = document.getElementById('totalReports');
    if (totalReportsEl) totalReportsEl.textContent = reports.length || 0;
    document.getElementById('monitoredAreas').textContent = dashboardData.length || 0;

    if (dashboardData.length > 0) {
      const avgHealth = Math.round(
        dashboardData.reduce((acc, d) => acc + Number(d.forestHealth || 0), 0) / dashboardData.length
      );
      document.getElementById('avgHealth').textContent = `${avgHealth}%`;
    } else {
      document.getElementById('avgHealth').textContent = 'N/A';
    }
  }

  function renderDashboardCards(data) {
    if (!data.length) {
      dashboardContainer.innerHTML = `
        <div class="card bg-card/80 backdrop-blur-sm border-forest-border">
          <div class="py-12 text-center">
            <p class="text-lg text-muted-foreground">No monitoring data available yet.</p>
          </div>
        </div>
      `;
      return;
    }

    dashboardContainer.innerHTML = data.map((entry, index) => {
      const healthStatus = getHealthStatus(Number(entry.forestHealth || 0));
      const encroachmentInfo = getEncroachmentLevel(Number(entry.encroachmentLevel || 0));

      return `
        <div class="card bg-card/80 backdrop-blur-sm border-forest-border hover:border-forest-primary/50 transition-all duration-300">
          <div class="card-header">
            <div class="flex items-start justify-between">
              <h3 class="card-title text-lg">Monitoring Area #${index + 1}</h3>
              <span class="badge ${healthStatus.color}">${healthStatus.label}</span>
            </div>
          </div>
          <div class="space-y-4">
            <div class="space-y-3">
              <div class="flex items-center justify-between">
                <span class="text-sm text-muted-foreground">Forest Health</span>
                <span class="text-lg font-semibold text-foreground">${entry.forestHealth || 0}%</span>
              </div>
              <div class="w-full bg-muted rounded-full h-2">
                <div class="bg-forest-primary h-2 rounded-full" style="width: ${entry.forestHealth || 0}%"></div>
              </div>
            </div>

            <div class="space-y-3">
              <div class="flex items-center justify-between">
                <span class="text-sm text-muted-foreground">Encroachment Level</span>
                <span class="badge ${encroachmentInfo.color}">${encroachmentInfo.label}</span>
                <span class="text-lg font-semibold text-foreground">${entry.encroachmentLevel || 0}%</span>
              </div>
              <div class="w-full bg-muted rounded-full h-2">
                <div class="bg-forest-accent h-2 rounded-full" style="width: ${entry.encroachmentLevel || 0}%"></div>
              </div>
            </div>
          </div>
        </div>
      `;
    }).join('');
  }

  function renderReportCards(reports) {
    if (!reportsContainer) return;
    if (!reports.length) {
      reportsContainer.innerHTML = `
        <div class="card bg-card/80 backdrop-blur-sm border-forest-border">
          <div class="py-12 text-center">
            <p class="text-lg text-muted-foreground">No reports submitted yet.</p>
          </div>
        </div>
      `;
      return;
    }

    reportsContainer.innerHTML = reports.slice(0, 10).map((report) => {
      const date = new Date(Number(report.timestamp) / 1000000);

      return `
        <div class="card bg-card/80 backdrop-blur-sm border-forest-border hover:border-forest-primary/50 transition-all duration-300">
          <div class="py-4">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
              <div class="flex-1 space-y-2">
                <div class="flex items-center gap-2">
                  <span class="font-medium text-foreground">${report.location || 'Unknown'}</span>
                </div>
                <p class="text-sm text-muted-foreground line-clamp-2">${report.incidentDetails || report.report || ''}</p>
              </div>
              <div class="text-xs text-muted-foreground whitespace-nowrap">
                ${date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })}
              </div>
            </div>
          </div>
        </div>
      `;
    }).join('');
  }

  function formatNdviLabels(ndviData) {
    return ndviData.map((entry) => {
      const year = entry.year ?? entry.Year ?? entry.YEAR;
      const month = entry.month ?? entry.Month ?? entry.MONTH;
      if (typeof year === 'undefined' || typeof month === 'undefined') {
        return 'Unknown';
      }
      return `${year}-${String(month).padStart(2, '0')}`;
    });
  }

  function formatNdviValues(ndviData) {
    return ndviData.map((entry) => {
      const raw = entry.RFDI ?? entry.NDVI ?? entry.ndvi ?? 0;
      const value = Number(raw);
      return Number.isFinite(value) ? Number(value.toFixed(3)) : 0;
    });
  }

  function renderNdviChart(ndviData) {
    console.log('renderNdviChart: Called with ndviData:', ndviData);
    if (!ndviCanvas) {
      console.log('renderNdviChart: No ndviCanvas element');
      return;
    }
    const labels = formatNdviLabels(ndviData);
    const values = formatNdviValues(ndviData);
    console.log('renderNdviChart: Formatted labels:', labels);
    console.log('renderNdviChart: Formatted values:', values);

    const context = ndviCanvas.getContext('2d');
    if (!context) {
      console.log('renderNdviChart: No 2d context available');
      return;
    }

    const dataset = {
      label: 'RFDI',
      data: values,
      borderColor: 'rgba(74, 222, 128, 0.9)',
      backgroundColor: 'rgba(74, 222, 128, 0.15)',
      tension: 0.35,
      fill: true,
      pointRadius: 2,
      pointBackgroundColor: 'rgba(74, 222, 128, 1)',
    };

    console.log('renderNdviChart: Creating/updating chart, Chart available:', typeof Chart);
    if (ndviChartInstance) {
      console.log('renderNdviChart: Updating existing chart');
      ndviChartInstance.data.labels = labels;
      ndviChartInstance.data.datasets[0].data = values;
      ndviChartInstance.update();
      return;
    }

    console.log('renderNdviChart: Creating new chart');
    ndviChartInstance = new Chart(context, {
      type: 'line',
      data: {
        labels,
        datasets: [dataset],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            suggestedMin: -0.2,
            suggestedMax: 1,
            grid: {
              color: 'rgba(255, 255, 255, 0.05)',
            },
            ticks: {
              color: 'rgba(255, 255, 255, 0.6)',
              callback: (value) => Number(value).toFixed(2),
            },
          },
          x: {
            ticks: {
              color: 'rgba(255, 255, 255, 0.6)',
              maxRotation: 0,
              autoSkipPadding: 16,
            },
            grid: {
              display: false,
            },
          },
        },
        plugins: {
          legend: {
            labels: {
              color: 'rgba(255, 255, 255, 0.8)',
            },
          },
          tooltip: {
            callbacks: {
              label: (context) => `RFDI: ${Number(context.parsed.y).toFixed(3)}`,
            },
          },
        },
      },
    });
  }

  async function loadNdviTrend(params = {}) {
    if (!ndviStatus || !ndviCanvas) return;

    try {
      console.log('loadNdviTrend: Starting fetch to /api/s1/trend with params:', params);
      const url = new URL('/api/s1/trend', window.location.origin);
      Object.keys(params).forEach(key => {
        if (params[key]) url.searchParams.append(key, params[key]);
      });
      const response = await fetch(url);
      console.log('loadNdviTrend: Response status:', response.status);
      if (!response.ok) {
        throw new Error('Failed to fetch RFDI trend');
      }

      const ndviData = await response.json();
      console.log('loadNdviTrend: Received ndviData:', ndviData);
      console.log('loadNdviTrend: ndviData type:', typeof ndviData, 'isArray:', Array.isArray(ndviData), 'length:', ndviData?.length);
      if (!Array.isArray(ndviData) || ndviData.length === 0) {
        console.log('loadNdviTrend: No data or empty array, setting status to no data');
        ndviStatus.textContent = 'No RFDI data available.';
        ndviCanvas.classList.add('hidden');
        ndviStatus.classList.remove('hidden');
        return;
      }

      console.log('loadNdviTrend: Data valid, hiding status and showing chart');
      ndviStatus.classList.add('hidden');
      ndviCanvas.classList.remove('hidden');
      renderNdviChart(ndviData);
      hasLoadedNdvi = true;
    } catch (error) {
      console.error('Error loading RFDI trend:', error);
      if (!hasLoadedNdvi) {
        ndviStatus.textContent = 'Unable to load RFDI trend.';
        ndviCanvas.classList.add('hidden');
        ndviStatus.classList.remove('hidden');
      }
    }
  }

  async function loadDashboard() {
    if (refreshTimer) {
      clearTimeout(refreshTimer);
    }

    try {
      console.log('loadDashboard: starting fetches');
      const dashboardResponse = await fetch('/api/dashboard/data');
      console.log('loadDashboard: dashboardResponse status:', dashboardResponse.status);

      const dashboardData = await dashboardResponse.json();
      let reports = [];
      if (window.userRole === 'admin') {
        const reportsResponse = await fetch('/api/whistle/reports');
        console.log('loadDashboard: reportsResponse status:', reportsResponse.status);
        reports = await reportsResponse.json();
      }

      console.log('loadDashboard: dashboardData length:', dashboardData.length);
      console.log('loadDashboard: reports length:', reports.length);

      updateSummaryCards(dashboardData, reports);
      renderDashboardCards(dashboardData);
      renderReportCards(reports);

      hasLoadedDashboard = true;
      hasLoadedReports = true;
    } catch (error) {
      console.error('Error loading dashboard:', error);

      if (!hasLoadedDashboard) {
        dashboardContainer.innerHTML = `
          <div class="card bg-card/80 backdrop-blur-sm border-forest-border">
            <div class="py-12 text-center">
              <p class="text-lg text-muted-foreground">Unable to load dashboard data. Please try again.</p>
            </div>
          </div>
        `;
      }

      if (!hasLoadedReports && reportsContainer) {
        reportsContainer.innerHTML = `
          <div class="card bg-card/80 backdrop-blur-sm border-forest-border">
            <div class="py-12 text-center">
              <p class="text-lg text-muted-foreground">Unable to load reports. Please try again.</p>
            </div>
          </div>
        `;
      }
    } finally {
      refreshTimer = setTimeout(() => loadDashboard(), REFRESH_INTERVAL);
    }
  }

  loadDashboard();

  (function() {
    const authToken = localStorage.getItem('authToken');
    const isLoginPage = window.location.pathname === '/login';
    console.log('Dashboard auth check: authToken present:', !!authToken);
    console.log('Dashboard auth check: isLoginPage:', isLoginPage);
    console.log('Dashboard auth check: currentPath:', window.location.pathname);

    if (!authToken && !isLoginPage) {
      console.log('Dashboard auth check: redirecting to login');
      const currentPath = window.location.pathname;
      window.location.href = '/login?redirect=' + encodeURIComponent(currentPath);
    } else {
      console.log('Dashboard auth check: auth ok, staying on page');
    }
  })();

  loadNdviTrend();

  async function loadPolicyAnalysis() {
    try {
      let token = sessionStorage.getItem('token');
      if (!token) {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
          const [name, value] = cookie.trim().split('=');
          if (name === 'sessionId') {
            token = value;
            break;
          }
        }
      }
      const headers = token ? { 'Authorization': `Bearer ${token}` } : {};
      const response = await fetch('/api/dashboard/policy-results', { headers });
      if (!response.ok) throw new Error('Failed to fetch policy results');
      const data = await response.json();
      renderPolicyAnalysis(data);
    } catch (error) {
      console.error('Error loading policy analysis:', error);
      document.getElementById('policyAnalysis').innerHTML = '<div class="text-center py-6 text-muted-foreground">Unable to load policy analysis.</div>';
    }
  }

  function getCorrelationStrength(coeff) {
    const absCoeff = Math.abs(coeff);
    if (absCoeff >= 0.8) return 'Strong';
    if (absCoeff >= 0.6) return 'Moderate';
    if (absCoeff >= 0.3) return 'Weak';
    return 'Very Weak';
  }

  function renderPolicyAnalysis(data) {
    let html = '<div class="space-y-6">';
    if (data.results) {
      html += '<div><h3 class="text-lg font-semibold mb-2">Policy Evaluation Results</h3><div class="text-sm whitespace-pre-wrap">' + data.results.replace(/\n/g, '<br>') + '</div>';
      html += '<div class="mt-4"><button id="downloadPdfBtn" class="px-4 py-2 bg-forest-primary text-white rounded-md hover:bg-forest-primary/80 transition-colors">Download PDF</button></div></div>';
    }
    if (data.correlation_analysis && !data.correlation_analysis.error) {
      const coeff = data.correlation_analysis.correlation_coefficient;
      const strength = coeff !== null && coeff !== undefined ? getCorrelationStrength(coeff) : 'N/A';
      html += '<div><h3 class="text-lg font-semibold mb-2">NDVI-GDP Correlation Analysis</h3>';
      html += '<p><strong>Correlation Strength:</strong> ' + strength + ' (' + (coeff !== null && coeff !== undefined ? coeff.toFixed(3) : 'N/A') + ')</p>';
      html += '<p><strong>P-Value:</strong> ' + (data.correlation_analysis.p_value || 'N/A') + '</p>';
      if (data.correlation_analysis.regression_summary) {
        html += '<details class="mt-4"><summary class="cursor-pointer text-forest-primary">View Regression Summary</summary><pre class="whitespace-pre-wrap text-xs mt-2 bg-muted p-2 rounded">' + data.correlation_analysis.regression_summary + '</pre></details>';
      }
      html += '</div>';

      // NDVI Prediction Section
      html += '<div><h3 class="text-lg font-semibold mb-2">Economic Impact Prediction</h3>';
      html += '<p class="text-sm text-muted-foreground mb-4">Enter an NDVI value to predict its economic impact on GDP.</p>';
      html += '<div class="flex gap-4 items-end">';
      html += '<div class="flex-1"><label class="block text-sm font-medium mb-2">NDVI Value (-1 to 1)</label><input type="number" id="ndviInput" min="-1" max="1" step="0.01" class="w-full px-3 py-2 bg-card border border-forest-border rounded-md text-foreground" placeholder="e.g., 0.5"></div>';
      html += '<button id="predictBtn" class="px-4 py-2 bg-forest-primary text-white rounded-md hover:bg-forest-primary/80 transition-colors">Predict GDP</button>';
      html += '</div>';
      html += '<div id="predictionResult" class="mt-4 text-sm"></div>';
      html += '</div>';
    } else if (data.correlation_analysis && data.correlation_analysis.error) {
      html += '<div><h3 class="text-lg font-semibold mb-2">Correlation Analysis</h3><p class="text-red-500">Error: ' + data.correlation_analysis.error + '</p></div>';
    }
    html += '</div>';
    document.getElementById('policyAnalysis').innerHTML = html;

    // Add event listener for prediction
    const predictBtn = document.getElementById('predictBtn');
    const ndviInput = document.getElementById('ndviInput');
    const predictionResult = document.getElementById('predictionResult');

    if (predictBtn && ndviInput && predictionResult) {
      predictBtn.addEventListener('click', async () => {
        const ndviValue = parseFloat(ndviInput.value);
        if (isNaN(ndviValue) || ndviValue < -1 || ndviValue > 1) {
          predictionResult.innerHTML = '<p class="text-red-500">Please enter a valid NDVI value between -1 and 1.</p>';
          return;
        }

        predictionResult.innerHTML = '<p class="text-muted-foreground">Predicting...</p>';

        try {
          const response = await fetch('/api/dashboard/ndvi/predict', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ndvi: ndviValue })
          });

          if (!response.ok) {
            throw new Error('Prediction failed');
          }

          const result = await response.json();
          const predictedGdp = result.predicted_gdp;
          predictionResult.innerHTML = '<p class="text-green-600"><strong>Predicted GDP:</strong> $' + predictedGdp.toLocaleString('en-US', { maximumFractionDigits: 2 }) + ' billion</p>';
        } catch (error) {
          console.error('Prediction error:', error);
          predictionResult.innerHTML = '<p class="text-red-500">Error: Unable to predict GDP. Please try again.</p>';
        }
      });
    }

    // Add event listener for PDF download
    const downloadPdfBtn = document.getElementById('downloadPdfBtn');
    if (downloadPdfBtn) {
      downloadPdfBtn.addEventListener('click', async () => {
        try {
          const response = await fetch('/api/dashboard/policy-pdf');
          if (!response.ok) {
            throw new Error('Failed to download PDF');
          }
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.style.display = 'none';
          a.href = url;
          a.download = 'policy_recommendations.pdf';
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(url);
          document.body.removeChild(a);
        } catch (error) {
          console.error('PDF download error:', error);
          alert('Error downloading PDF. Please try again.');
        }
      });
    }
  }

  // Filter and alerts functionality
  const yearFilter = document.getElementById('yearFilter');
  const forestFilter = document.getElementById('forestFilter');
  const monthFilter = document.getElementById('monthFilter');
  const alertsCount = document.getElementById('alertsCount');

  function populateFilters(data) {
    const years = [...new Set(data.map(d => d.year))].sort();
    const forests = [...new Set(data.map(d => d.forest))].sort();
    const months = [...new Set(data.map(d => d.month))].sort();

    yearFilter.innerHTML = '<option value="">All Years</option>' + years.map(y => `<option value="${y}">${y}</option>`).join('');
    forestFilter.innerHTML = '<option value="">All Forests</option>' + forests.map(f => `<option value="${f}">${f}</option>`).join('');
    monthFilter.innerHTML = '<option value="">All Months</option>' + months.map(m => `<option value="${m}">${m}</option>`).join('');
  }

  async function loadFilteredData() {
    const year = yearFilter.value;
    const forest = forestFilter.value;
    const month = monthFilter.value;

    const params = { year, forest, month };

    try {
      const response = await fetch(`/filtered-data?${new URLSearchParams(params)}`);
      const result = await response.json();
      alertsCount.textContent = result.alert_count || 0;

      // Populate filters only on initial load (no filters selected)
      if (!year && !forest && !month) {
        populateFilters(result.data || []);
      }

      // Update RFDI trend chart with filters
      loadNdviTrend(params);
    } catch (error) {
      console.error('Error loading filtered data:', error);
    }
  }

  // Add event listeners for filter changes
  yearFilter.addEventListener('change', loadFilteredData);
  forestFilter.addEventListener('change', loadFilteredData);
  monthFilter.addEventListener('change', loadFilteredData);

  // Initial load
  loadFilteredData();

  loadPolicyAnalysis();
</script>

</body>
</html>
